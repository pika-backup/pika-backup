app-id: org.gnome.World.PikaBackup
command: pika-backup
runtime: org.gnome.Platform
runtime-version: 'master'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin
  build-args:
    - "--share=network"

finish-args:
  - --filesystem=host
  # flatpak puts a tmpfs here to hide other apps
  # it contains configs of all flatpak apps
  - --filesystem=~/.var/app/
  # flatpak puts a tmpfs here to hide all apps
  # it contains the apps and overrides for app priviledges
  - --filesystem=xdg-data/flatpak:ro
  # sftp mounts etc.
  - --share=network
  - --socket=wayland
  # X11
  - --share=ipc
  - --socket=fallback-x11
  # SSH-keys etc
  - --socket=ssh-auth
  # GVfs (gio::Device etc)
  - --talk-name=org.gtk.vfs
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-run/gvfs
  - --filesystem=xdg-run/gvfsd
  # UPower (OnBattery)
  - --system-talk-name=org.freedesktop.UPower
  # fusermount
  - --device=all
  - --talk-name=org.freedesktop.Flatpak.*
  # open folder in filebrowser, work around buggy OpenURI portal
  # https://gitlab.gnome.org/World/pika-backup/-/issues/19
  - --talk-name=org.freedesktop.FileManager1
  # see https://github.com/flatpak/flatpak/issues/4280
  - --unset-env=LD_PRELOAD
modules:
  - name: Jinja2
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=. --prefix=/app Jinja2
    cleanup: ['*']
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/91/a5/429efc6246119e1e3fbf562c00187d04e83e54619249eb732bb423efa6c6/Jinja2-3.0.3.tar.gz
        sha256: 611bb273cd68f3b993fabdc4064fc858c5b47a973cb5aa7999ec1ba405c87cd7
      - type: file
        url: https://files.pythonhosted.org/packages/62/0f/52c009332fdadd484e898dc8f2acca0663c1031b3517070fd34ad9c1b64e/MarkupSafe-2.1.0.tar.gz
        sha256: 80beaf63ddfbc64a0452b841d8036ca0611e049650e20afcb882f5d3c266d65f

  - name: systemd
    buildsystem: meson
    build-options:
      prefix: /app/systemd-build
    config-opts:
      - -Drootprefix=/app/systemd-build
      - --sysconfdir=/app/systemd-build/etc
    post-install:
      - mkdir -p /app/share/pkgconfig/
      - cp /app/systemd-build/share/pkgconfig/udev.pc /app/share/pkgconfig/udev.pc
      - mkdir -p /app/lib
      - cp -r /app/systemd-build/lib/udev /app/lib/udev
    cleanup: ['*']
    sources:
      - type: archive
        url: https://github.com/systemd/systemd/archive/refs/tags/v249.tar.gz
        sha256: 174091ce5f2c02123f76d546622b14078097af105870086d18d55c1c2667d855
        x-checker-data:
          type: anitya
          project-id: 5440
          url-template: https://github.com/systemd/systemd/archive/refs/tags/v$version.tar.gz

  - name: fusermout
    buildsystem: meson
    config-opts:
      - -Dexamples=false
      - -Duseroot=false
      - -Dtests=false
      #- MOUNT_FUSE_PATH=/app/bin
     # - -Dutils=false
    sources:
      - type: archive
        url: https://github.com/libfuse/libfuse/releases/download/fuse-3.10.5/fuse-3.10.5.tar.xz
        sha256: b2e283485d47404ac896dd0bb7f7ba81e1470838e677e45f659804c3a3b69666
        x-checker-data:
          type: anitya
          project-id: 861
          url-template: https://github.com/libfuse/libfuse/releases/download/fuse-$version/fuse-$version.tar.xz
          versions: {<: '4.0'}

  - name: host-command-wrapper
    buildsystem: simple
    build-commands:
      - install fusermount-wrapper.sh /app/bin/fusermount3
      - install umount-wrapper.sh /app/bin/umount
    sources:
      - type: file
        path: fusermount-wrapper.sh
      - type: file
        path: umount-wrapper.sh

  - name: borg
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=. --prefix=/app pkgconfig
      - pip3 install --no-index --find-links=. --prefix=/app setuptools_scm
      - pip3 install --no-index --find-links=. --prefix=/app pyfuse3
      - pip3 install --no-index --find-links=. --prefix=/app borgbackup
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c4/e0/e05fee8b5425db6f83237128742e7e5ef26219b687ab8f0d41ed0422125e/pkgconfig-1.5.5.tar.gz
        sha256: deb4163ef11f75b520d822d9505c1f462761b4309b1bb713d08689759ea8b899
        x-checker-data:
          type: pypi
          name: pkgconfig
          versions: {'>=': '1.5.5'}
      # pkgconfig dependency
      - type: file
        url: https://files.pythonhosted.org/packages/51/be/c4dce945cf7de2dc38d94cf724525f2a97d83b18403eeeb87eecb715dada/poetry-core-1.0.8.tar.gz
        sha256: 951fc7c1f8d710a94cb49019ee3742125039fc659675912ea614ac2aa405b118
        x-checker-data:
          type: pypi
          name: poetry-core
          versions: {'>=': '1.0.8'}
      - type: file
        url: https://files.pythonhosted.org/packages/54/85/514ba3ca2a022bddd68819f187ae826986051d130ec5b972076e4f58a9f3/setuptools_scm-3.2.0.tar.gz
        sha256: 52ab47715fa0fc7d8e6cd15168d1a69ba995feb1505131c3e814eb7087b57358
        x-checker-data:
          type: pypi
          name: setuptools_scm
          versions: {<: '3.3'}
      - type: file
        url: https://files.pythonhosted.org/packages/11/c6/9e16df5a5526f7dd2ad17284928e36fc341305fe74c7ab06bb5960a5da94/setuptools-58.0.2.tar.gz
        sha256: 19e48d0270a86c996bf09e5282584d3c0adf407f37f0aa6e3c762a349ff41811
        x-checker-data:
          type: pypi
          name: setuptools
      - type: file
        url: https://files.pythonhosted.org/packages/4e/be/8139f127b4db2f79c8b117c80af56a3078cc4824b5b94250c7f81a70e03b/wheel-0.37.0.tar.gz
        sha256: e2ef7239991699e3355d54f8e968a21bb940a1dbf34a4d226741e64462516fad
        x-checker-data:
          type: pypi
          name: wheel
      - type: file
        url: https://files.pythonhosted.org/packages/c1/47/dfc9c342c9842bbe0036c7f763d2d6686bcf5eb1808ba3e170afdb282210/pyparsing-2.4.7.tar.gz
        sha256: c203ec8783bf771a155b207279b9bccb8dea02d8f0c9e5f8ead507bc3246ecc1
        x-checker-data:
          type: pypi
          name: wheel
      - type: file
        url: https://files.pythonhosted.org/packages/df/86/aef78bab3afd461faecf9955a6501c4999933a48394e90f03cd512aad844/packaging-21.0.tar.gz
        sha256: 7dc96269f53a4ccec5c0670940a4281106dd0bb343f47b7471f779df49c2fbe7
        x-checker-data:
          type: pypi
          name: packaging
      - type: file
        url: https://files.pythonhosted.org/packages/61/3c/2206f39880d38ca7ad8ac1b28d2d5ca81632d163b2d68ef90e46409ca057/msgpack-1.0.3.tar.gz
        sha256: 51fdc7fb93615286428ee7758cecc2f374d5ff363bdd884c7ea622a7a327a81e
        x-checker-data:
          type: pypi
          name: msgpack
          versions: {==: '1.0.3'}
      - type: file
        url: https://files.pythonhosted.org/packages/0f/e9/0b07aaff39e22eee9a983a48507bff46cf0d634e8a24e635e336cd7b3bce/borgbackup-1.2.0.tar.gz
        sha256: e39a5547902ef456101aa4c779fa66b345bda70d16788e8bd18e458f93af7f67
        x-checker-data:
          type: pypi
          name: borgbackup
          versions: {'>=': 1.2.0}
      # pyfuse3 + extra dependencies for it
      - type: file
        url: https://files.pythonhosted.org/packages/2f/99/ceb3f424cfac5011b6749160285fa265a2297344351381f524cdbb5542a2/pyfuse3-3.2.1.tar.gz
        sha256: 22d146dac59a8429115e9a93317975ea54b35e0278044a94d3fac5b4ad5f7e33
        x-checker-data:
          type: pypi
          name: pyfuse3
          versions: {<: '4.0'}
      - type: file
        url: https://files.pythonhosted.org/packages/0a/0f/e9c02a866e32d85fdead0f1c9425b31ba57b69dd08714770232089cc7839/trio-0.20.0.tar.gz
        sha256: 670a52d3115d0e879e1ac838a4eb999af32f858163e3a704fe4839de2a676070
        x-checker-data:
          type: pypi
          name: trio
      - type: file
        url: https://files.pythonhosted.org/packages/ce/b6/6fa6b3b598a03cba5e80f829e0dadbb49d7645f523d209b2fb7ea0bbb02a/async_generator-1.10.tar.gz
        sha256: 6ebb3d106c12920aaae42ccb6f787ef5eefdcdd166ea3d628fa8476abe712144
        x-checker-data:
          type: pypi
          name: async_generator
          versions: {<: '2'}
      - type: file
        url: https://files.pythonhosted.org/packages/d7/77/ebb15fc26d0f815839ecd897b919ed6d85c050feeb83e100e020df9153d2/attrs-21.4.0.tar.gz
        sha256: 626ba8234211db98e869df76230a137c4c40a12d72445c45d5f5b716f076e2fd
        x-checker-data:
          type: pypi
          name: attrs
      - type: file
        url: https://files.pythonhosted.org/packages/e8/c4/ba2f8066cceb6f23394729afe52f3bf7adec04bf9ed2c820b39e19299111/sortedcontainers-2.4.0.tar.gz
        sha256: 25caa5a06cc30b6b83d11423433f65d1f9d76c4c6a0c90e3379eaa43b9bfdb88
        x-checker-data:
          type: pypi
          name: sortedcontainers
          versions: {<: '3'}
      - type: file
        url: https://files.pythonhosted.org/packages/a6/ae/44ed7978bcb1f6337a3e2bef19c941de750d73243fc9389140d62853b686/sniffio-1.2.0.tar.gz
        sha256: c4666eecec1d3f50960c6bdf61ab7bc350648da6c126e3cf6898d8cd4ddcd3de
        x-checker-data:
          type: pypi
          name: sniffio
          versions: {<: '2'}
      - type: file
        url: https://files.pythonhosted.org/packages/88/b5/9ccedd89d641dcfa5771f636a8a2e99f9d98b09f511f4f870d382ef2b007/outcome-1.1.0.tar.gz
        sha256: e862f01d4e626e63e8f92c38d1f8d5546d3f9cce989263c521b2e7990d186967
        x-checker-data:
          type: pypi
          name: outcome
          versions: {<: '2'}
      - type: file
        url: https://files.pythonhosted.org/packages/62/08/e3fc7c8161090f742f504f40b1bccbfc544d4a4e09eb774bf40aafce5436/idna-3.3.tar.gz
        sha256: 9d643ff0a55b762d5cdb124b8eaa99c66322e2157b69160bc32796e824360e6d
        x-checker-data:
          type: pypi
          name: idna
          versions: {<: '4'}

  - name: pika-backup
    buildsystem: meson
    config-opts:
      - -Dprofile=release
    sources:
      - type: git
        url: https://gitlab.gnome.org/World/pika-backup.git
        tag: v0.3.0-beta.3
        commit: 10d7053bfb4ddeca1cd9ff985b1e470715da1e67
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      # generated via flatpak-builder-tools
      - generated-sources.json

